{"version":3,"file":"handler.js","sources":["../uiApiProxy.ts"],"sourcesContent":["import express, { json, urlencoded, static as staticEx } from 'express';\nimport asyncify from 'express-asyncify';\n\nimport cookieParser from 'cookie-parser';\nimport { join } from 'path';\nimport { fileURLToPath } from 'url';\n\nimport fileUpload from 'express-fileupload';\nimport cors from 'cors';\nimport fetch from 'node-fetch';\n\nconst Ports = {\n  core: {\n    serviceHub: process.env.SERVICEHUB_INTERNAL_PORT || '4100'\n  }\n};\n\nconst _dirname = typeof __dirname !== 'undefined' ? __dirname : join(fileURLToPath(new URL('.', import.meta.url)), '..');\n\n// Initialize Express application\nconst app = asyncify(express());\n\napp.use((_req: any, res: any, next: any) => {\n  res.socket.setTimeout(0); // 5 minutes\n  next();\n})\n\n// app.use(logger('tiny', { stream: ConsoleStream() }))\napp.use(json({ limit: '500mb' }));\napp.use(urlencoded({ limit: '500mb', extended: true }));\napp.use(cookieParser());\napp.use(staticEx(join(_dirname, 'public')));\napp.use(fileUpload({\n  limits: {\n    // When the frontend calls us with a mix of JSON and file data (encoded as\n    // a multipart form), the fields are first parsed by busboy (a dependency\n    // of the express-fileupload lib). Busboy limits the size of multipart fie.\n    // to a really low value by default, so here we unshackle it. The overall\n    // request continues to have an upper limit imposed by NGINX and the ingre:\n    // controller.\n    fieldSize: Infinity\n  }\n}));\nconst corsoptions = {\n  origin: '*',\n  allowedHeaders: '*',\n  optionsSuccessStatus: 200 // some legacy browsers (IE11, various SmartTVs) chol\n};\napp.use(cors(corsoptions));\napp.use('/api/v1', async (req, res, next) => {\n  let url\n  try {\n    console.log(`received request for url:${req.url}`);\n    url = new URL(`${req.protocol}://${req.host}${req.url}`);\n    console.log(`host is ${req.host}`);\n  } catch (err) {\n    console.log(`not a valid url for bff, so back to vite: ${req.protocol}://`);\n    next(); // not a valid url so not for us\n    return;\n  }\n  try {\n    // Rewrite the request to point to the internal core df service\n    // TODO: replace the simple 'internalHost' logic with a obfuscation layer\n    // that maps external non-revealing host refs to internal hostnames\n    const internalHost = `${url.host.split(':')[0]}:${Ports.core.serviceHub}`;\n    let queryParams = Object.entries(req.query ?? {}).map(([key, value]: [string, any])  =>\n      `${key}=${encodeURIComponent(value)}`).join('&');\n    if (queryParams && queryParams.length > 0) {\n      queryParams = '?' + queryParams;\n    }\n    const urlText = `${url.protocol}//${internalHost}/api/v1${req.url.split('?')[0]}${queryParams}`;\n    const newUrl = new URL(urlText);\n    console.log(`MSP UI request to ${req.originalUrl} redirected to ${newUrl}`);\n    console.log(`body type is ${typeof req.body}`);\n    const bodyContent = (typeof req.body === 'string') ? req.body : JSON.stringify(req.body);\n    const controller = new AbortController();\n    const simpleHeaders = Object.entries(req.headers || {}).reduce((acc, [key, value]) => {\n      if (Array.isArray(value)) {\n        acc[key] = value.join(', ');\n      } else if (value !== undefined) {\n        acc[key] = value;\n      }\n      return acc;\n    }, {} as Record<string, string>);\n    const upstreamRes = await fetch(newUrl,\n      {\n        ...req,\n        method: req.method,\n        body: req.method === 'GET' ? null : bodyContent,\n        headers: { ...simpleHeaders, host: newUrl.host },\n        signal: controller.signal\n      }\n    );\n    if (upstreamRes.status === 304) {\n      res.status(304);\n      const allowed304Headers = [\n        'etag', 'last-modified', 'cache-control', 'expires', 'date', 'vary'\n      ];\n      for (const header of allowed304Headers) {\n        const value = upstreamRes.headers.get(header);\n        if (value) {\n          res.setHeader(header, value);\n        }\n      }\n      res.end();\n      return;\n    }\n    res.status(upstreamRes.status);\n    upstreamRes.headers.forEach((value, key) => {\n      res.setHeader(key, value);\n    });\n    const stream = upstreamRes.body?.pipe(res);\n    upstreamRes.body?.on('error', (err) => {\n      console.error('Error in upstream response stream:', err);\n      controller.abort();\n      res.end();\n    });\n\n    stream?.on('error', (err) => {\n      console.error('Error piping response stream:', err);\n      res.end();\n    })\n\n    req.socket.on('close', () => {\n      if (!res.writableEnded) {\n        console.log('Request socket closed prematurely, aborting upstream request');\n        stream?.destroy();\n        controller.abort();\n      }\n    })\n\n    console.log(`Bff request to ${req.originalUrl} completed with status ${upstreamRes.status}`);\n    return\n  } catch (err) {\n    console.error(`Error processing Bff request to ${req.originalUrl}:`, err);\n    res.status(500).json({ error: 'Internal Server Error' });\n  }\n});\n\napp.use((req, _res, next) => {\n  console.log(`Bff passing through request for url:${req.url} back to vite`);\n  next();\n});\n\nexport default app;\n    "],"names":["staticEx"],"mappings":";;;;;;;;;;;;;AAWA,MAAM,QAAQ;AAAA,EACZ,MAAM;AAAA,IACJ,YAAY,QAAQ,IAAI,4BAA4B;AAAA,EAAA;AAExD;AAEA,MAAM,WAAW,OAAO,cAAc,cAAc,YAAY,KAAK,cAAc,IAAI,IAAI,KAAK,YAAY,GAAG,CAAC,GAAG,IAAI;AAGvH,MAAM,MAAM,SAAS,SAAS;AAE9B,IAAI,IAAI,CAAC,MAAW,KAAU,SAAc;AACtC,MAAA,OAAO,WAAW,CAAC;AAClB,OAAA;AACP,CAAC;AAGD,IAAI,IAAI,KAAK,EAAE,OAAO,QAAS,CAAA,CAAC;AAChC,IAAI,IAAI,WAAW,EAAE,OAAO,SAAS,UAAU,KAAA,CAAM,CAAC;AACtD,IAAI,IAAI,cAAc;AACtB,IAAI,IAAIA,QAAS,KAAK,UAAU,QAAQ,CAAC,CAAC;AAC1C,IAAI,IAAI,WAAW;AAAA,EACjB,QAAQ;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,IAON,WAAW;AAAA,EAAA;AAEf,CAAC,CAAC;AACF,MAAM,cAAc;AAAA,EAClB,QAAQ;AAAA,EACR,gBAAgB;AAAA,EAChB,sBAAsB;AAAA;AACxB;AACA,IAAI,IAAI,KAAK,WAAW,CAAC;AACzB,IAAI,IAAI,WAAW,OAAO,KAAK,KAAK,SAAS;;AACvC,MAAA;AACA,MAAA;AACF,YAAQ,IAAI,4BAA4B,IAAI,GAAG,EAAE;AAC3C,UAAA,IAAI,IAAI,GAAG,IAAI,QAAQ,MAAM,IAAI,IAAI,GAAG,IAAI,GAAG,EAAE;AACvD,YAAQ,IAAI,WAAW,IAAI,IAAI,EAAE;AAAA,WAC1B,KAAK;AACZ,YAAQ,IAAI,6CAA6C,IAAI,QAAQ,KAAK;AACrE,SAAA;AACL;AAAA,EAAA;AAEE,MAAA;AAIF,UAAM,eAAe,GAAG,IAAI,KAAK,MAAM,GAAG,EAAE,CAAC,CAAC,IAAI,MAAM,KAAK,UAAU;AACnE,QAAA,cAAc,OAAO,QAAQ,IAAI,SAAS,EAAE,EAAE,IAAI,CAAC,CAAC,KAAK,KAAK,MAChE,GAAG,GAAG,IAAI,mBAAmB,KAAK,CAAC,EAAE,EAAE,KAAK,GAAG;AAC7C,QAAA,eAAe,YAAY,SAAS,GAAG;AACzC,oBAAc,MAAM;AAAA,IAAA;AAEtB,UAAM,UAAU,GAAG,IAAI,QAAQ,KAAK,YAAY,UAAU,IAAI,IAAI,MAAM,GAAG,EAAE,CAAC,CAAC,GAAG,WAAW;AACvF,UAAA,SAAS,IAAI,IAAI,OAAO;AAC9B,YAAQ,IAAI,qBAAqB,IAAI,WAAW,kBAAkB,MAAM,EAAE;AAC1E,YAAQ,IAAI,gBAAgB,OAAO,IAAI,IAAI,EAAE;AACvC,UAAA,cAAe,OAAO,IAAI,SAAS,WAAY,IAAI,OAAO,KAAK,UAAU,IAAI,IAAI;AACjF,UAAA,aAAa,IAAI,gBAAgB;AACvC,UAAM,gBAAgB,OAAO,QAAQ,IAAI,WAAW,CAAA,CAAE,EAAE,OAAO,CAAC,KAAK,CAAC,KAAK,KAAK,MAAM;AAChF,UAAA,MAAM,QAAQ,KAAK,GAAG;AACxB,YAAI,GAAG,IAAI,MAAM,KAAK,IAAI;AAAA,MAAA,WACjB,UAAU,QAAW;AAC9B,YAAI,GAAG,IAAI;AAAA,MAAA;AAEN,aAAA;AAAA,IACT,GAAG,EAA4B;AAC/B,UAAM,cAAc,MAAM;AAAA,MAAM;AAAA,MAC9B;AAAA,QACE,GAAG;AAAA,QACH,QAAQ,IAAI;AAAA,QACZ,MAAM,IAAI,WAAW,QAAQ,OAAO;AAAA,QACpC,SAAS,EAAE,GAAG,eAAe,MAAM,OAAO,KAAK;AAAA,QAC/C,QAAQ,WAAW;AAAA,MAAA;AAAA,IAEvB;AACI,QAAA,YAAY,WAAW,KAAK;AAC9B,UAAI,OAAO,GAAG;AACd,YAAM,oBAAoB;AAAA,QACxB;AAAA,QAAQ;AAAA,QAAiB;AAAA,QAAiB;AAAA,QAAW;AAAA,QAAQ;AAAA,MAC/D;AACA,iBAAW,UAAU,mBAAmB;AACtC,cAAM,QAAQ,YAAY,QAAQ,IAAI,MAAM;AAC5C,YAAI,OAAO;AACL,cAAA,UAAU,QAAQ,KAAK;AAAA,QAAA;AAAA,MAC7B;AAEF,UAAI,IAAI;AACR;AAAA,IAAA;AAEE,QAAA,OAAO,YAAY,MAAM;AAC7B,gBAAY,QAAQ,QAAQ,CAAC,OAAO,QAAQ;AACtC,UAAA,UAAU,KAAK,KAAK;AAAA,IAAA,CACzB;AACD,UAAM,UAAS,iBAAY,SAAZ,mBAAkB,KAAK;AACtC,sBAAY,SAAZ,mBAAkB,GAAG,SAAS,CAAC,QAAQ;AAC7B,cAAA,MAAM,sCAAsC,GAAG;AACvD,iBAAW,MAAM;AACjB,UAAI,IAAI;AAAA,IAAA;AAGF,qCAAA,GAAG,SAAS,CAAC,QAAQ;AACnB,cAAA,MAAM,iCAAiC,GAAG;AAClD,UAAI,IAAI;AAAA,IAAA;AAGN,QAAA,OAAO,GAAG,SAAS,MAAM;AACvB,UAAA,CAAC,IAAI,eAAe;AACtB,gBAAQ,IAAI,8DAA8D;AAC1E,yCAAQ;AACR,mBAAW,MAAM;AAAA,MAAA;AAAA,IACnB,CACD;AAED,YAAQ,IAAI,kBAAkB,IAAI,WAAW,0BAA0B,YAAY,MAAM,EAAE;AAC3F;AAAA,WACO,KAAK;AACZ,YAAQ,MAAM,mCAAmC,IAAI,WAAW,KAAK,GAAG;AACxE,QAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,yBAAyB;AAAA,EAAA;AAE3D,CAAC;AAED,IAAI,IAAI,CAAC,KAAK,MAAM,SAAS;AAC3B,UAAQ,IAAI,uCAAuC,IAAI,GAAG,eAAe;AACpE,OAAA;AACP,CAAC;;"}